<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Blog Post</title>
        <link rel="stylesheet" href="assets/css/styles.css" />
    </head>
    <body>
        <a href="index.html" class="back-link">&larr; Back to Home</a>
        <div id="post-container">Loading post...</div>

        <script>
            // Parse query parameter by name
            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }

            // Basic markdown renderer (same as main.js)
            function renderMarkdown(mdText) {
                let html = mdText
                    .replace(/^### (.*$)/gim, "<h3>$1</h3>")
                    .replace(/^## (.*$)/gim, "<h2>$1</h2>")
                    .replace(/^# (.*$)/gim, "<h1>$1</h1>")
                    .replace(/\*\*(.*?)\*\*/gim, "<b>$1</b>")
                    .replace(/\*(.*?)\*/gim, "<i>$1</i>")
                    .replace(/\n\n+/g, "</p><p>")
                    .replace(/\n/g, "<br/>");
                return "<p>" + html + "</p>";
            }

            async function loadPostBySlug(slug) {
                const container = document.getElementById("post-container");
                if (!slug) {
                    container.innerHTML =
                        "<p>Error: No post slug specified.</p>";
                    return;
                }

                try {
                    // Fetch posts/index.json to get all filenames
                    const indexResponse = await fetch("posts/index.json");
                    if (!indexResponse.ok)
                        throw new Error("Failed to load posts index");
                    const files = await indexResponse.json();

                    // Find the filename matching the slug
                    const matchedFile = files.find((filename) =>
                        filename.includes(slug),
                    );
                    if (!matchedFile) throw new Error("Post not found");

                    // Fetch the matched post JSON file
                    const postResponse = await fetch("posts/" + matchedFile);
                    if (!postResponse.ok)
                        throw new Error("Failed to load post file");
                    const post = await postResponse.json();

                    // Render post content
                    container.innerHTML = `
          <h1>${post.title}</h1>
          <p class="post-meta"><em>${post.date}</em> | Tags: ${post.tags.join(", ")}</p>
          <div>${renderMarkdown(post.content)}</div>
        `;
                } catch (error) {
                    container.innerHTML = `<p>Error loading post: ${error.message}</p>`;
                }
            }

            const slug = getQueryParam("slug");
            loadPostBySlug(slug);
        </script>
    </body>
</html>
